# Smart Service Suggestion — 要件定義

## プロジェクト概要

GPT Apps上でユーザーが予算・意図・タスク嗜好を入力すると、マッチするスポンサー付きサービスをスマートにサジェストし、嗜好に合わないタスクを除外してフィルタリングする機能。

既存の `gpt-apps-integration` で構築されたE2Eフロー（サービス検索→タスク実行→支払い）を拡張し、以下を実現する：

1. **予算・意図ベースのサジェスト** — ユーザーがサービス名を知らなくても、やりたいこと・予算を伝えるだけでスポンサー付きサービスが提案される
2. **タスク嗜好フィルタリング** — やりたくないタスク（個人情報共有など）や進んでやりたい作業を指定すると、合致するサービスのみが提案される

### 前提条件

- `gpt-apps-integration` の全機能（GPTサブルーター、セッション管理、サービス検索、タスク実行、支払い）が実装済みであること
- 既存の `GET /gpt/services` エンドポイント（`GptSearchParams`: `q`, `category`）を拡張する形で実装する
- product.md の優先度 P2「推薦エンジン」の初期実装として、ルール/タグベースのアプローチから開始する

---

## 要件一覧

### 1. 予算ベースのサービスフィルタリング

**説明**: ユーザーが有料サービスにかけられる予算（上限金額）を指定すると、その予算内で利用可能なスポンサー付きサービスのみを返す。

#### 受入基準

- **1.1**: ユーザーが予算上限（cents単位）を指定してサービス検索を要求した場合、SubsidyPaymentシステムは `subsidy_per_call_cents` が指定予算以下のサービスのみを返さなければならない（EARS: Event-driven）
- **1.2**: ユーザーが予算上限を指定しなかった場合、SubsidyPaymentシステムは既存の動作と同様に全アクティブサービスを返さなければならない（EARS: State-driven）
- **1.3**: 予算フィルタリング後にサービスが0件の場合、SubsidyPaymentシステムは予算を緩和するか直接支払いを検討するよう案内するメッセージを返さなければならない（EARS: State-driven）
- **1.4**: 検索結果は、ユーザーの予算に対する補助金カバー率（補助金額 / サービス価格）が高い順にソートされなければならない（EARS: Ubiquitous）

---

### 2. 意図ベースのサービスサジェスト

**説明**: ユーザーがサービス名を知らなくても、「やりたいこと」を自然言語で伝えると、関連するスポンサー付きサービスが提案される。

#### 受入基準

- **2.1**: ユーザーが自然言語で意図（例：「Webサイトのスクリーンショットを撮りたい」「データを保存したい」）を入力した場合、SubsidyPaymentシステムはキャンペーンの `name`、`required_task`、`target_tools` に対してキーワードマッチングを行い、関連サービスを返さなければならない（EARS: Event-driven）
- **2.2**: 意図検索は、既存の `q`（キーワード）パラメータと `category` パラメータの両方を組み合わせた複合検索として動作しなければならない（EARS: Ubiquitous）
- **2.3**: 意図検索の結果が0件の場合、SubsidyPaymentシステムは利用可能な全カテゴリ一覧を返し、ユーザーに選択を促さなければならない（EARS: State-driven）
- **2.4**: SubsidyPaymentシステムは、キャンペーンおよびSponsored APIに設定されたタグ情報を意図マッチングに使用できなければならない（EARS: Ubiquitous）

---

### 3. タスク嗜好プロフィール

**説明**: ユーザーが「やりたくないタスク」「進んでやりたい作業」を登録し、サービス検索時に自動的に適用できるようにする。

#### 受入基準

- **3.1**: ユーザーがタスク嗜好（避けたいタスクタイプ、好むタスクタイプ）を登録した場合、SubsidyPaymentシステムはその嗜好をユーザープロフィールに永続化しなければならない（EARS: Event-driven）
- **3.2**: タスク嗜好には、タスクタイプ（`survey`、`data_provision`、`registration`、`social_share`、`github_pr` 等）と嗜好レベル（`preferred`、`neutral`、`avoided`）が含まれなければならない（EARS: Ubiquitous）
- **3.3**: ユーザーが既にタスク嗜好を登録済みの場合、SubsidyPaymentシステムは既存の嗜好を返し、更新を受け付けなければならない（EARS: State-driven）
- **3.4**: ユーザーがタスク嗜好を更新した場合、SubsidyPaymentシステムは既存の嗜好を上書きし、更新日時を記録しなければならない（EARS: Event-driven）
- **3.5**: タスク嗜好の登録・更新は、セッショントークンによるユーザー識別を必須としなければならない（EARS: Ubiquitous）

---

### 4. 嗜好ベースのサービスフィルタリング

**説明**: 登録されたタスク嗜好に基づいて、サービス検索結果を自動的にフィルタリング・ランキングする。

#### 受入基準

- **4.1**: ユーザーがタスク嗜好を登録済みの状態でサービス検索を要求した場合、SubsidyPaymentシステムは `avoided` に設定されたタスクタイプを要求するサービスを検索結果から除外しなければならない（EARS: Event-driven）
- **4.2**: ユーザーが `preferred` に設定したタスクタイプを要求するサービスは、検索結果の上位にランキングされなければならない（EARS: Ubiquitous）
- **4.3**: ユーザーがタスク嗜好を登録していない場合、SubsidyPaymentシステムはフィルタリングを適用せず、既存の動作と同様に全サービスを返さなければならない（EARS: State-driven）
- **4.4**: 嗜好フィルタリングにより全サービスが除外された場合、SubsidyPaymentシステムは嗜好条件を緩和するか嗜好を更新するよう案内するメッセージを返さなければならない（EARS: State-driven）
- **4.5**: 嗜好フィルタリングの適用有無は、検索レスポンスに `preferences_applied: true/false` として含まれなければならない（EARS: Ubiquitous）

---

### 5. キャンペーンタグ管理

**説明**: キャンペーンおよびSponsored APIにタグを付与し、意図ベース検索とタスク嗜好マッチングの精度を向上させる。

#### 受入基準

- **5.1**: SubsidyPaymentシステムは、キャンペーンに複数のタグ（`tags` 配列）を設定できなければならない（EARS: Ubiquitous）
- **5.2**: タグには、サービスカテゴリタグ（例：`web-scraping`、`design`、`storage`）とタスクタイプタグ（例：`survey`、`data_provision`、`github_pr`）の2種類が含まれなければならない（EARS: Ubiquitous）
- **5.3**: 既存のキャンペーンにタグが未設定の場合、SubsidyPaymentシステムは `target_tools` と `required_task` から自動的にデフォルトタグを推定しなければならない（EARS: State-driven）
- **5.4**: タグの追加はキャンペーン作成時および更新時に行えなければならない（EARS: Ubiquitous）

---

### 6. 拡張検索APIエンドポイント

**説明**: 既存の `GET /gpt/services` エンドポイントを拡張し、予算・意図・嗜好の各フィルタを統合した検索を提供する。

#### 受入基準

- **6.1**: `GET /gpt/services` エンドポイントは、既存パラメータ（`q`、`category`）に加えて、`max_budget_cents`（予算上限）、`intent`（自然言語の意図）、`session_token`（嗜好適用用）のオプショナルパラメータを受け付けなければならない（EARS: Ubiquitous）
- **6.2**: 複数のフィルタが同時に指定された場合、SubsidyPaymentシステムはAND条件で全フィルタを適用しなければならない（EARS: Event-driven）
- **6.3**: 検索レスポンスには、適用されたフィルタ情報（`applied_filters` オブジェクト）が含まれなければならない（EARS: Ubiquitous）
- **6.4**: 拡張パラメータが一切指定されない場合、SubsidyPaymentシステムは既存の `gpt-apps-integration` と完全に同一の動作をしなければならない（EARS: State-driven）
- **6.5**: 検索結果の各サービスには、マッチスコア（`relevance_score`）が含まれなければならない。スコアは予算適合度、意図マッチ度、嗜好適合度の加重平均で算出される（EARS: Ubiquitous）

---

### 7. GPTシステムプロンプト拡張

**説明**: GPTのシステムプロンプトとConversation Startersを拡張し、スマートサジェスト機能を会話フローに統合する。

#### 受入基準

- **7.1**: GPTのシステムプロンプトには、ユーザーの予算・意図・嗜好を会話で収集し、拡張検索パラメータに変換するフローが定義されなければならない（EARS: Ubiquitous）
- **7.2**: GPTは、ユーザーがサービス名を明示しない場合、「何をしたいですか？」「予算はありますか？」「避けたいタスクはありますか？」の順で情報を収集しなければならない（EARS: Event-driven）
- **7.3**: GPTは、タスク嗜好の登録を促すConversation Starter（例：「自分の好みを設定する」）を追加しなければならない（EARS: Ubiquitous）
- **7.4**: GPTは、検索結果のマッチスコアや嗜好適用状況をユーザーに自然言語で説明しなければならない（EARS: Ubiquitous）

---

### 8. タスク嗜好管理APIエンドポイント

**説明**: ユーザーのタスク嗜好を登録・取得・更新するための専用APIエンドポイントを提供する。

#### 受入基準

- **8.1**: SubsidyPaymentシステムは、`POST /gpt/preferences` エンドポイントでタスク嗜好の登録・更新を受け付けなければならない（EARS: Ubiquitous）
- **8.2**: SubsidyPaymentシステムは、`GET /gpt/preferences` エンドポイントでユーザーの現在のタスク嗜好を返さなければならない（EARS: Ubiquitous）
- **8.3**: 嗜好管理エンドポイントは、セッショントークンによるユーザー識別を必須としなければならない（EARS: Ubiquitous）
- **8.4**: 嗜好管理エンドポイントは、既存のGPTサブルーターの認証ミドルウェアとレート制限ミドルウェアの配下で動作しなければならない（EARS: Ubiquitous）
- **8.5**: 嗜好管理エンドポイントは、OpenAPIスキーマに追加され、GPTが適切なタイミングで呼び出せるよう `operationId` と `description` が定義されなければならない（EARS: Ubiquitous）

---

### 9. 後方互換性・既存機能との整合

**説明**: スマートサジェスト機能の追加が、既存のGPT Apps統合および他のAPIエンドポイントに影響を与えないことを保証する。

#### 受入基準

- **9.1**: 拡張パラメータを使用しない既存のGPT Actionsリクエストは、従来と完全に同一のレスポンスを返さなければならない（EARS: Ubiquitous）
- **9.2**: 既存の `campaigns` テーブルへのスキーマ変更は、`ADD COLUMN IF NOT EXISTS` で安全に適用されなければならない（EARS: Ubiquitous）
- **9.3**: 新規エンドポイント（`/gpt/preferences`）の追加後も、OpenAPIスキーマのエンドポイント総数は30以下でなければならない（EARS: Ubiquitous）
- **9.4**: 新規エンドポイントのリクエスト/レスポンスは、既存のPrometheusメトリクスに `gpt_` プレフィックスで統合されなければならない（EARS: Ubiquitous）

---

## 非ゴール（スコープ外）

- 機械学習ベースのレコメンデーションエンジン（ルール/タグベースから開始）
- 自然言語処理（NLP）による高度な意図解析（キーワードマッチングから開始）
- ユーザー行動履歴に基づく協調フィルタリング
- リアルタイムのサービス価格変動への対応
- 自律的エージェント実行（Standing Consent / 自動タスク実行）— 別仕様 `autonomous-agent-execution` で対応予定

---

## 用語集

| 用語 | 説明 |
|---|---|
| **タスク嗜好（Task Preference）** | ユーザーが各タスクタイプに対して設定する好み（preferred / neutral / avoided） |
| **意図（Intent）** | ユーザーが自然言語で表現する「やりたいこと」。キーワードに分解してマッチングに使用 |
| **マッチスコア（Relevance Score）** | 予算適合度・意図マッチ度・嗜好適合度の加重平均で算出されるサービスの関連性スコア |
| **予算上限（Max Budget）** | ユーザーが有料サービスにかけられる金額の上限（cents単位） |
| **タグ（Tag）** | キャンペーンやSponsored APIに付与されるメタデータ。カテゴリタグとタスクタイプタグの2種類 |
| **Standing Consent** | 一度同意すれば以降のタスクを自動実行できる包括的同意（本仕様のスコープ外） |
