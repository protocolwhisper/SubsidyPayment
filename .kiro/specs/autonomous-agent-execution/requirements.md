# Autonomous Agent Execution — 要件定義

## プロジェクト概要

自律型エージェント（Claude、GPT、カスタムボット等のAIエージェント）がユーザーの代わりにSubsidyPaymentシステム上でタスクを発見・選択・実行し、スポンサー決済によるリソース取得までのフローを**人間の介入なしに**自動化する。

本仕様は、SubsidyPaymentバックエンドが自律型エージェントに対して提供するAPI・認証・安全装置・監査の要件を定義する。エージェント自体の実装ではなく、エージェントが利用するシステム側のインターフェースとガードレールに焦点を当てる。

---

## 要件一覧

### 1. エージェントAPIインターフェース

**説明**: 自律型エージェントがSubsidyPaymentシステムの全フロー（サービス発見→タスク実行→支払い→リソース取得）をプログラム的に実行するためのAPI群を提供する。

#### 受入基準

- **1.1**: SubsidyPaymentシステムは、エージェント専用のAPIルート（`/agent/*`プレフィックス）を提供しなければならない（EARS: Ubiquitous）
- **1.2**: エージェントAPIの全レスポンスは、機械解析可能な構造化JSON（`status`、`data`、`next_actions`フィールドを含む）で返されなければならない（EARS: Ubiquitous）
- **1.3**: 各APIレスポンスの`next_actions`フィールドには、エージェントが次に呼び出すべきエンドポイントとパラメータのヒントが含まれなければならない（EARS: Ubiquitous）
- **1.4**: SubsidyPaymentシステムは、エージェントがフロー全体の状態を1回の呼び出しで確認できるステータスエンドポイント（`/agent/flow/status`）を提供しなければならない（EARS: Ubiquitous）
- **1.5**: エージェントAPIは、既存の`/gpt/*`エンドポイントおよび内部APIとの後方互換性を維持しなければならない（EARS: Ubiquitous）

---

### 2. エージェント認証・認可

**説明**: エージェントがユーザーの代理としてシステムにアクセスするための認証・認可メカニズムを提供する。

#### 受入基準

- **2.1**: SubsidyPaymentシステムは、エージェント用のAPIキー認証（Bearerトークン）を提供しなければならない（EARS: Ubiquitous）
- **2.2**: エージェントがAPIキーで認証した場合、SubsidyPaymentシステムはエージェントを特定のユーザーアカウントに紐付けるセッションを発行しなければならない（EARS: Event-driven）
- **2.3**: エージェントセッションには、ユーザーが事前に許可した操作スコープ（サービスカテゴリ、予算上限、データ提供範囲）が含まれなければならない（EARS: Ubiquitous）
- **2.4**: エージェントがスコープ外の操作を要求した場合、SubsidyPaymentシステムは403ステータスと具体的なスコープ違反理由を返さなければならない（EARS: Event-driven）
- **2.5**: エージェントセッションの有効期限は最大24時間とし、期限切れの場合はSubsidyPaymentシステムは401ステータスと再認証指示を返さなければならない（EARS: State-driven）

---

### 3. 自律的サービスディスカバリ

**説明**: エージェントがユーザーの目的・嗜好に基づいて最適なスポンサー付きサービスをプログラム的に検索・評価・選択できる。

#### 受入基準

- **3.1**: エージェントが検索クエリ（キーワード、カテゴリ、目的記述）を送信した場合、SubsidyPaymentシステムは関連度スコア付きのサービス一覧を返さなければならない（EARS: Event-driven）
- **3.2**: 検索結果には、各サービスの`service_id`、スポンサー名、必要タスク種別、補助金額、タスク所要時間の推定値が含まれなければならない（EARS: Ubiquitous）
- **3.3**: エージェントがユーザーの嗜好パラメータ（許容タスク種別、最大所要時間、データ提供範囲）を指定した場合、SubsidyPaymentシステムは条件に合致しないサービスをフィルタリングして返さなければならない（EARS: Event-driven）
- **3.4**: スポンサー付きサービスが存在しない場合、SubsidyPaymentシステムは直接支払いオプションと代替サービス候補を返さなければならない（EARS: State-driven）
- **3.5**: SubsidyPaymentシステムは、一回の検索で最大50件の結果を返し、ページネーションパラメータ（`offset`、`limit`）をサポートしなければならない（EARS: Ubiquitous）

---

### 4. 自律的タスク実行

**説明**: エージェントがスポンサーの要求するタスク（アンケート回答、データ提供、サービス登録等）をユーザーに代わって自動的に実行する。

#### 受入基準

- **4.1**: エージェントがサービスを選択した場合、SubsidyPaymentシステムは該当キャンペーンの必要タスク詳細（タスク種別、入力スキーマ、必須/任意フィールド）を返さなければならない（EARS: Event-driven）
- **4.2**: タスクの入力スキーマは、JSON Schemaフォーマットで定義され、エージェントがプログラム的にバリデーション可能でなければならない（EARS: Ubiquitous）
- **4.3**: エージェントがタスク入力データを送信した場合、SubsidyPaymentシステムは入力をスキーマに対してバリデーションし、不備があれば具体的なフィールドエラーを返さなければならない（EARS: Event-driven）
- **4.4**: タスク実行前に、SubsidyPaymentシステムはエージェントのセッションスコープにタスク種別と提供データ種別が含まれていることを検証しなければならない（EARS: Ubiquitous）
- **4.5**: エージェントが既にタスク完了済みのキャンペーンにタスク送信した場合、SubsidyPaymentシステムはタスクをスキップし、直接サービス実行ステップの情報を返さなければならない（EARS: State-driven）
- **4.6**: タスク完了後、SubsidyPaymentシステムはタスク完了レコードにエージェント実行であることを示すメタデータ（`execution_mode: "agent"`、`agent_id`）を記録しなければならない（EARS: Ubiquitous）

---

### 5. 自律的支払い・リソース取得

**説明**: タスク完了後、エージェントが自動的にスポンサー決済を経てx402保護リソースを取得する。

#### 受入基準

- **5.1**: タスクが完了済みのエージェントがサービス実行を要求した場合、SubsidyPaymentシステムはスポンサー決済を自動実行し、リソースレスポンスを返さなければならない（EARS: Event-driven）
- **5.2**: スポンサー決済が成功した場合、SubsidyPaymentシステムは支払い記録（`tx_hash`、`campaign_id`、`amount`、`agent_id`）をデータベースに保存しなければならない（EARS: Event-driven）
- **5.3**: スポンサーの予算が不足している場合、SubsidyPaymentシステムはエージェントに予算不足を通知し、代替スポンサーまたは直接支払いオプションを`next_actions`に含めて返さなければならない（EARS: State-driven）
- **5.4**: サービス実行結果は、エージェントが後続処理を判断できるよう、リソースデータと実行メタデータ（レスポンスタイム、コスト、ステータス）を含む構造化JSONで返されなければならない（EARS: Ubiquitous）
- **5.5**: エージェントのセッション予算上限を超える決済が発生する場合、SubsidyPaymentシステムは決済を実行せず、ユーザーへの追加承認を要求するレスポンスを返さなければならない（EARS: State-driven）

---

### 6. 同意・ユーザー制御

**説明**: エージェントによる自律的操作においても、ユーザーの明示的同意とコントロールを確保する。

#### 受入基準

- **6.1**: ユーザーがエージェントセッションを作成する際、SubsidyPaymentシステムは操作スコープ（許可するタスク種別、データ提供範囲、予算上限）の明示的設定を要求しなければならない（EARS: Event-driven）
- **6.2**: エージェントがユーザーの個人データ（メール、属性等）をスポンサーに送信するタスクを実行する前に、SubsidyPaymentシステムはセッションスコープにデータ種別ごとの同意が含まれていることを検証しなければならない（EARS: Ubiquitous）
- **6.3**: ユーザーはエージェントセッションをいつでも無効化でき、無効化された場合、SubsidyPaymentシステムは以降のエージェントリクエストをすべて拒否しなければならない（EARS: Event-driven）
- **6.4**: エージェントが同意されていないデータ種別の提供を試みた場合、SubsidyPaymentシステムはデータ転送を行わず、必要な同意項目を明示したエラーレスポンスを返さなければならない（EARS: Unwanted behavior）
- **6.5**: 同意記録には、エージェント経由での付与であることを示すメタデータ（`granted_via: "agent"`、`agent_session_id`）が含まれなければならない（EARS: Ubiquitous）

---

### 7. 安全装置・レート制限

**説明**: エージェントの暴走・悪用を防ぐための安全装置を提供する。

#### 受入基準

- **7.1**: エージェントAPIに対するレート制限は、1エージェントセッションあたり毎分30リクエストとしなければならない（EARS: Ubiquitous）
- **7.2**: レート制限に達した場合、SubsidyPaymentシステムは429ステータスと`Retry-After`ヘッダーを返さなければならない（EARS: State-driven）
- **7.3**: エージェントセッションあたりの累計決済額が予算上限に達した場合、SubsidyPaymentシステムは以降の決済リクエストを拒否し、ユーザーへの通知を返さなければならない（EARS: State-driven）
- **7.4**: エージェントが短時間に同一サービスへの重複リクエストを送信した場合、SubsidyPaymentシステムは重複を検知し、2回目以降のリクエストを拒否しなければならない（EARS: Unwanted behavior）
- **7.5**: SubsidyPaymentシステムは、エージェントセッションの異常パターン（急激なリクエスト増加、スコープ外操作の連続試行）を検知した場合、セッションを一時停止しなければならない（EARS: Event-driven）

---

### 8. 監査・オブザーバビリティ

**説明**: エージェントによる全操作の追跡可能性と監視を確保する。

#### 受入基準

- **8.1**: エージェント経由の全APIリクエストは、`agent_session_id`、`agent_id`、操作種別、タイムスタンプを含む監査ログに記録されなければならない（EARS: Ubiquitous）
- **8.2**: ユーザーは自身のエージェント操作履歴を取得するエンドポイント（`/agent/audit/history`）を通じて、エージェントが実行した全操作を確認できなければならない（EARS: Ubiquitous）
- **8.3**: エージェントAPIのリクエスト数、レイテンシ、エラー率は既存のPrometheusメトリクスに統合されなければならない（EARS: Ubiquitous）
- **8.4**: エージェントセッションの作成・失効・無効化イベントは、構造化ログ（tracing）に記録されなければならない（EARS: Ubiquitous）
- **8.5**: 決済を伴うエージェント操作は、ユーザーへの事後通知（監査履歴への記録と取得可能性）が保証されなければならない（EARS: Ubiquitous）

---

### 9. エラーハンドリング・リカバリ

**説明**: エージェントが自律的にエラーから回復するための情報を提供する。

#### 受入基準

- **9.1**: SubsidyPaymentシステムは、すべてのエージェントAPIエラーレスポンスにおいて、`error_code`（機械判読用）、`message`（人間用）、`retry_allowed`（再試行可否）、`next_actions`（代替手段）を含む構造化JSONを返さなければならない（EARS: Ubiquitous）
- **9.2**: 上流サービス（x402保護リソース）がタイムアウトした場合、SubsidyPaymentシステムは504ステータスと推奨再試行間隔を返さなければならない（EARS: Event-driven）
- **9.3**: スポンサー決済が一時的に失敗した場合、SubsidyPaymentシステムは決済状態を`pending`として保存し、エージェントにポーリングエンドポイントを返さなければならない（EARS: Event-driven）
- **9.4**: エージェントが不正なリクエストボディを送信した場合、SubsidyPaymentシステムは400ステータスと具体的なフィールドバリデーションエラー（JSON Schema違反箇所）を返さなければならない（EARS: Event-driven）
- **9.5**: 内部エラーが発生した場合、SubsidyPaymentシステムは500ステータスを返し、内部実装の詳細を漏洩してはならない（EARS: Unwanted behavior）

---

## 非ゴール（スコープ外）

- エージェント自体の実装（本仕様はシステム側のインターフェース定義）
- MCP（Model Context Protocol）サーバーの実装（将来的な拡張として検討）
- エージェント間（A2A）通信プロトコルの策定
- 高度な推薦アルゴリズム（初期はスコアリングAPIのみ提供）
- マルチエージェントオーケストレーション
- ユーザー向けリアルタイム通知（初期はポーリング型の監査履歴のみ）

---

## 用語集

| 用語 | 説明 |
|---|---|
| **自律型エージェント** | ユーザーの代わりにAPI呼び出しを自動的に行うAIエージェント（Claude、GPT、カスタムボット等） |
| **エージェントセッション** | エージェントがユーザーに紐付いて操作するための認証済みセッション。操作スコープと予算上限を含む |
| **操作スコープ** | エージェントに許可された操作範囲（タスク種別、データ提供範囲、予算上限）。ユーザーがセッション作成時に設定 |
| **next_actions** | APIレスポンスに含まれる、エージェントが次に取るべきアクションのヒント情報 |
| **予算上限** | エージェントセッションに設定された累計決済額の上限。超過時は決済を拒否 |
| **監査ログ** | エージェントの全操作を記録した追跡可能なログ |
| **x402** | HTTP 402ベースのペイメントプロトコル |
| **Sponsor** | ユーザーのタスク実行と引き換えに支払いを肩代わりするエンティティ |
| **Campaign** | スポンサーが作成する募集単位（ターゲット、タスク、予算等を含む） |

---
