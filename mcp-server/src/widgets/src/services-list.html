<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Services List Widget</title>
    <style>
      :root {
        --bg-0: #0f172a;
        --bg-1: #0c1222;
        --panel: #111827;
        --panel-soft: #1e293b;
        --border: #334155;
        --text: #f8fafc;
        --muted: #94a3b8;
        --chip: #1f2937;
        --accent: #0ea5e9;
        --accent-soft: rgba(14, 165, 233, 0.16);
      }

      body.dark {
        --bg-0: #0b1220;
        --bg-1: #080e1a;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 100%);
        color: var(--text);
      }

      #app {
        width: 100%;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 18px 44px rgba(2, 6, 23, 0.45);
      }

      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        padding: 20px 24px;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .sparkles {
        color: var(--accent);
        display: inline-flex;
      }

      .title {
        margin: 0;
        font-size: 18px;
        font-weight: 700;
        letter-spacing: -0.25px;
      }

      .badge {
        padding: 4px 10px;
        border: 1px solid var(--accent);
        border-radius: 999px;
        background: var(--accent-soft);
        color: var(--accent);
        font-size: 12px;
        font-weight: 600;
      }

      .search-wrap {
        padding: 0 24px 12px;
      }

      .search {
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        padding: 10px 14px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: var(--panel-soft);
        color: var(--muted);
        font-size: 13px;
      }

      .divider {
        width: 100%;
        height: 1px;
        background: var(--border);
      }

      .chips {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px 24px;
      }

      .chip {
        border-radius: 999px;
        border: 1px solid var(--border);
        background: var(--chip);
        color: #dbe5f3;
        padding: 8px 14px;
        font-size: 12px;
      }

      .chip.active {
        border-color: var(--accent);
        background: var(--accent-soft);
        color: #bae6fd;
      }

      .card-list {
        display: grid;
        gap: 10px;
        padding: 8px 24px 18px;
      }

      .service-card {
        width: 100%;
        text-align: left;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.5);
        color: inherit;
        cursor: pointer;
        padding: 12px;
      }

      .service-card:hover {
        border-color: rgba(14, 165, 233, 0.6);
      }

      .service-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
      }

      .service-main {
        display: flex;
        align-items: flex-start;
        gap: 10px;
      }

      .service-icon {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        background: #1e293b;
        border: 1px solid #334155;
        color: #e2e8f0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
      }

      .service-name {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
      }

      .service-desc {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--muted);
      }

      .arrow {
        color: #64748b;
      }

      .task-tags {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .task-tag {
        border-radius: 999px;
        background: rgba(51, 65, 85, 0.45);
        color: #cbd5e1;
        font-size: 11px;
        padding: 3px 8px;
      }

      .footer {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px 18px;
        color: var(--muted);
        font-size: 12px;
      }

      .empty {
        margin: 8px 24px 18px;
        border: 1px dashed var(--border);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.4);
        color: var(--muted);
        padding: 18px;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <main id="app"></main>
    <script>
      function initWidget() {
        const app = window.openai;
        const isDark = app?.theme?.appearance === 'dark';
        document.body.classList.toggle('dark', isDark);

        if (typeof app?.maxHeight === 'number' && Number.isFinite(app.maxHeight)) {
          document.body.style.maxHeight = `${app.maxHeight}px`;
          document.body.style.overflowY = 'auto';
        }

        return {
          app,
          toolOutput: app?.toolOutput ?? null,
          toolResponseMetadata: app?.toolResponseMetadata ?? null,
          widgetState: app?.widgetState ?? {},
          isDark,
        };
      }

      function notifyWidgetHeight(app) {
        const height = Math.max(
          document.body?.scrollHeight || 0,
          document.documentElement?.scrollHeight || 0
        );
        app?.notifyIntrinsicHeight?.(height);
      }

      const globals = initWidget();
      const app = globals.app;
      const root = document.getElementById('app');
      let toolOutput = globals.toolOutput;
      let widgetState = globals.widgetState;

      function normalizeStructuredContent(value) {
        if (!value || typeof value !== 'object') return {};
        if (value.structuredContent && typeof value.structuredContent === 'object') {
          return value.structuredContent;
        }
        return value;
      }

      function currentStructuredContent() {
        return normalizeStructuredContent(toolOutput);
      }

      function currentWidgetState() {
        return widgetState && typeof widgetState === 'object' ? widgetState : {};
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      function toDisplayLabel(value) {
        if (typeof value !== 'string' || value.trim().length === 0) return 'Unknown';
        return value
          .trim()
          .split(/[-_\s]+/)
          .filter(Boolean)
          .map((part) => part.charAt(0).toUpperCase() + part.slice(1))
          .join(' ');
      }

      function resolveServiceKey(item) {
        if (typeof item?.service_key === 'string' && item.service_key.length > 0) return item.service_key;
        if (Array.isArray(item?.category) && item.category.length > 0 && typeof item.category[0] === 'string') {
          return item.category[0];
        }
        if (typeof item?.name === 'string' && item.name.length > 0) {
          return item.name.toLowerCase().replace(/\s+/g, '-');
        }
        return '';
      }

      function buildCards() {
        const structuredContent = currentStructuredContent();
        const candidateServices = Array.isArray(structuredContent.candidate_services) ? structuredContent.candidate_services : [];
        const services = Array.isArray(structuredContent.services) ? structuredContent.services : [];
        if (candidateServices.length > 0) {
          return candidateServices.map((candidate) => {
            const offers = Array.isArray(candidate.offers) ? candidate.offers : [];
            const firstOffer = offers[0] ?? null;
            const requiredTasks = offers
              .map((offer) => offer.required_task)
              .filter((value) => typeof value === 'string' && value.length > 0)
              .slice(0, 3);

            return {
              campaign_id: firstOffer?.campaign_id ?? '',
              service_key: candidate.service_key,
              display_name: candidate.display_name ?? toDisplayLabel(candidate.service_key),
              sponsor: offers[0]?.sponsor ?? 'Sponsor',
              description: candidate.reason ?? 'Recommended for your request',
              subsidy_amount_cents: firstOffer?.subsidy_amount_cents ?? 0,
              category: [candidate.service_key],
              relevance_score: null,
              tasks: requiredTasks,
            };
          });
        }

        return services.map((service) => {
          const tags = Array.isArray(service.tags) ? service.tags : [];
          return {
            campaign_id: service.service_id,
            service_key: resolveServiceKey(service),
            display_name: service.name ?? service.display_name ?? toDisplayLabel(resolveServiceKey(service)),
            sponsor: service.sponsor ?? 'Sponsor',
            description: `Sponsored by ${service.sponsor ?? 'sponsor'}`,
            subsidy_amount_cents: service.subsidy_amount_cents ?? 0,
            category: Array.isArray(service.category) ? service.category : [],
            relevance_score: service.relevance_score ?? null,
            tasks: [service.required_task, ...tags].filter((value) => typeof value === 'string' && value.length > 0).slice(0, 3),
          };
        });
      }

      async function callTool(name, input) {
        return app?.callTool?.(name, input);
      }

      async function setWidgetState(nextState) {
        return app?.setWidgetState?.(nextState);
      }

      async function selectService(campaignId, serviceKey, serviceName) {
        if (!campaignId) return;
        await setWidgetState({
          ...(currentWidgetState() ?? {}),
          selectedServiceId: campaignId,
          selectedServiceKey: serviceKey,
          selectedServiceName: serviceName,
        });
        await callTool('get_task_details', { campaign_id: campaignId });
      }

      function render() {
        if (!root) return;
        const structuredContent = currentStructuredContent();
        const candidateServices = Array.isArray(structuredContent.candidate_services) ? structuredContent.candidate_services : [];
        const services = Array.isArray(structuredContent.services) ? structuredContent.services : [];
        const serviceCatalog = Array.isArray(structuredContent.service_catalog) ? structuredContent.service_catalog : [];
        const selectedServiceKey =
          typeof currentWidgetState()?.selectedServiceKey === 'string' ? currentWidgetState().selectedServiceKey : '';
        const keyword =
          typeof structuredContent?.applied_filters?.keyword === 'string' ? structuredContent.applied_filters.keyword : '';

        const cards = buildCards();
        const serviceCount = cards.length;
        const chips = [
          { label: 'All', key: 'all' },
          ...serviceCatalog.slice(0, 4).map((item) => ({
            label: item.display_name ?? toDisplayLabel(item.service_key),
            key: item.service_key,
          })),
        ];

        const cardsHtml = cards.length
          ? cards
              .map((service) => {
                const initials = String(service.display_name || 'SV')
                  .split(/\s+/)
                  .filter(Boolean)
                  .slice(0, 2)
                  .map((token) => token.charAt(0).toUpperCase())
                  .join('');
                return `
                  <button class="service-card" data-campaign-id="${escapeHtml(service.campaign_id)}" data-service-key="${escapeHtml(service.service_key)}" data-service-name="${escapeHtml(service.display_name)}">
                    <div class="service-row">
                      <div class="service-main">
                        <span class="service-icon">${escapeHtml(initials || 'SV')}</span>
                        <div>
                          <p class="service-name">${escapeHtml(service.display_name)}</p>
                          <p class="service-desc">${escapeHtml(service.description)}</p>
                        </div>
                      </div>
                      <span class="arrow">&rsaquo;</span>
                    </div>
                    <div class="task-tags">
                      <span class="task-tag">Subsidy ${escapeHtml((Number(service.subsidy_amount_cents || 0) / 100).toFixed(2))} USD</span>
                      <span class="task-tag">Relevance ${escapeHtml(service.relevance_score ?? '-')}</span>
                      ${(service.category ?? []).slice(0, 2).map((cat) => `<span class="task-tag">${escapeHtml(cat)}</span>`).join('')}
                    </div>
                    <div class="task-tags">
                      ${service.tasks.length > 0
                        ? service.tasks.map((task) => `<span class="task-tag">${escapeHtml(task)}</span>`).join('')
                        : '<span class="task-tag">No task metadata</span>'}
                    </div>
                  </button>
                `;
              })
              .join('')
          : '<div class="empty">No services match the current criteria.</div>';

        root.innerHTML = `
          <section class="header">
            <div class="header-left">
              <span class="sparkles">âœ¦</span>
              <h2 class="title">Recommended Services</h2>
            </div>
            <span class="badge">${serviceCount} service${serviceCount === 1 ? '' : 's'}</span>
          </section>
          <section class="search-wrap">
            <div class="search">ðŸ”Ž ${escapeHtml(keyword || 'Search services...')}</div>
          </section>
          <div class="divider"></div>
          <section class="chips">
            ${chips
              .map((chip, index) => {
                const active = index === 0 || chip.key === selectedServiceKey;
                return `<span class="chip ${active ? 'active' : ''}">${escapeHtml(chip.label)}</span>`;
              })
              .join('')}
          </section>
          <section class="card-list">${cardsHtml}</section>
          <section class="footer">ðŸ’¬ Suggested based on your conversation</section>
        `;

        for (const card of root.querySelectorAll('.service-card')) {
          card.addEventListener('click', () => {
            const campaignId = card.getAttribute('data-campaign-id');
            const serviceKey = card.getAttribute('data-service-key');
            const serviceName = card.getAttribute('data-service-name');
            if (campaignId && serviceKey) {
              void selectService(campaignId, serviceKey, serviceName ?? serviceKey);
            }
          });
        }

        notifyWidgetHeight(app);
        setTimeout(() => notifyWidgetHeight(app), 50);
      }

      function safeRender() {
        try {
          render();
        } catch (error) {
          if (root) {
            root.innerHTML = `<div class="empty">Widget render error: ${escapeHtml(error?.message || 'unknown error')}</div>`;
          }
          console.error('services-list widget render error', error);
          notifyWidgetHeight(app);
        }
      }

      window.addEventListener('openai:set_globals', () => {
        toolOutput = window.openai?.toolOutput ?? toolOutput;
        widgetState = window.openai?.widgetState ?? widgetState;
        safeRender();
      });

      safeRender();
      notifyWidgetHeight(app);
    </script>
  </body>
</html>
