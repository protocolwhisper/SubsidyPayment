<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Service Tasks Widget</title>
    <style>
      :root {
        --bg-0: #0f172a;
        --bg-1: #0c1222;
        --panel: #111827;
        --panel-soft: #1e293b;
        --border: #334155;
        --text: #f8fafc;
        --muted: #94a3b8;
        --accent: #0ea5e9;
        --success: #22c55e;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--text);
        font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 100%);
      }

      #app {
        width: 100%;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 18px 44px rgba(2, 6, 23, 0.45);
      }

      .header {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 18px 20px;
      }

      .back {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--muted);
        cursor: pointer;
      }

      .service-title {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
      }

      .service-sub {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: 12px;
      }

      .divider {
        width: 100%;
        height: 1px;
        background: var(--border);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 8px;
        padding: 14px 20px 10px;
      }

      .section-title {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
      }

      .badge {
        border: 1px solid var(--accent);
        border-radius: 999px;
        color: var(--accent);
        background: rgba(14, 165, 233, 0.16);
        font-size: 11px;
        font-weight: 600;
        padding: 3px 9px;
      }

      .list {
        display: grid;
        gap: 10px;
        padding: 0 20px 14px;
      }

      .task-card {
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.55);
        padding: 12px;
      }

      .row-top {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
      }

      .task-name {
        margin: 0;
        font-size: 14px;
        font-weight: 700;
      }

      .task-desc {
        margin: 2px 0 0;
        font-size: 12px;
        color: var(--muted);
      }

      .amount {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        border: 1px solid rgba(34, 197, 94, 0.5);
        background: rgba(34, 197, 94, 0.15);
        color: #86efac;
        padding: 4px 9px;
        font-size: 12px;
        font-weight: 700;
      }

      .row-bottom {
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
      }

      .sponsor {
        font-size: 12px;
        color: var(--muted);
      }

      .start {
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        border-radius: 9px;
        padding: 6px 10px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
      }

      .total {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        margin: 2px 20px 16px;
        border-radius: 10px;
        border: 1px solid rgba(14, 165, 233, 0.45);
        background: rgba(14, 165, 233, 0.14);
        color: #bae6fd;
        padding: 10px 12px;
        font-size: 13px;
        font-weight: 600;
      }

      .empty {
        margin: 12px 20px 16px;
        border-radius: 12px;
        border: 1px dashed var(--border);
        color: var(--muted);
        font-size: 13px;
        background: rgba(15, 23, 42, 0.45);
        padding: 16px;
      }
    </style>
  </head>
  <body>
    <main id="app"></main>
    <script>
      function initWidget() {
        const app = window.openai;
        const isDark = app?.theme?.appearance === 'dark';
        document.body.classList.toggle('dark', isDark);

        if (typeof app?.maxHeight === 'number' && Number.isFinite(app.maxHeight)) {
          document.body.style.maxHeight = `${app.maxHeight}px`;
          document.body.style.overflowY = 'auto';
        }

        return {
          app,
          toolOutput: app?.toolOutput ?? null,
          widgetState: app?.widgetState ?? {},
          isDark,
        };
      }

      function notifyWidgetHeight(app) {
        app?.notifyIntrinsicHeight?.(document.body.scrollHeight);
      }

      const { app, toolOutput, widgetState } = initWidget();
      const root = document.getElementById('app');

      const structured = toolOutput?.structuredContent ?? {};
      const tasks = Array.isArray(structured.tasks) ? structured.tasks : [];
      const displayName = structured.display_name ?? structured.service_key ?? 'Service';
      const taskCount = Number(structured.task_count ?? tasks.length);
      const totalSubsidyCents = Number(structured.total_subsidy_cents ?? 0);
      const serviceKey = typeof structured.service_key === 'string' ? structured.service_key : widgetState?.selectedServiceKey ?? '';

      function escapeHtml(value) {
        return String(value ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      function formatDollars(cents) {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD',
        }).format((Number(cents) || 0) / 100);
      }

      async function callTool(name, input) {
        return app?.callTool?.(name, input);
      }

      async function setWidgetState(nextState) {
        return app?.setWidgetState?.(nextState);
      }

      async function onStartTask(campaignId, sponsor, requiredTask) {
        await setWidgetState({
          ...(widgetState ?? {}),
          selectedCampaignId: campaignId,
          selectedSponsor: sponsor,
          selectedRequiredTask: requiredTask,
          selectedServiceKey: serviceKey,
          selectedServiceName: displayName,
        });
        await callTool('get_task_details', { campaign_id: campaignId });
      }

      async function onBack() {
        await callTool('search_services', {
          q: typeof displayName === 'string' ? displayName : undefined,
        });
      }

      function renderTaskCards() {
        return tasks
          .map((task) => {
            const title = task.required_task || 'Task';
            const desc = task.campaign_name || 'Campaign task';
            return `
              <article class="task-card">
                <div class="row-top">
                  <div>
                    <p class="task-name">${escapeHtml(title)}</p>
                    <p class="task-desc">${escapeHtml(desc)}</p>
                  </div>
                  <span class="amount">üéÅ ${escapeHtml(formatDollars(task.subsidy_amount_cents))}</span>
                </div>
                <div class="row-bottom">
                  <span class="sponsor">by ${escapeHtml(task.sponsor ?? '-')}</span>
                  <button class="start" data-campaign-id="${escapeHtml(task.campaign_id)}" data-task-name="${escapeHtml(title)}" data-sponsor="${escapeHtml(task.sponsor ?? '')}">
                    Start ‚Ä∫
                  </button>
                </div>
              </article>
            `;
          })
          .join('');
      }

      function render() {
        if (!root) return;

        root.innerHTML = `
          <section class="header">
            <button class="back" id="back-btn">‚Üê</button>
            <div>
              <h2 class="service-title">${escapeHtml(displayName)}</h2>
              <p class="service-sub">Available subsidized tasks</p>
            </div>
          </section>
          <div class="divider"></div>
          <section class="section-header">
            <h3 class="section-title">Available Subsidized Tasks</h3>
            <span class="badge">${escapeHtml(taskCount)} task${taskCount === 1 ? '' : 's'}</span>
          </section>
          ${tasks.length > 0 ? `<section class="list">${renderTaskCards()}</section>` : `<div class="empty">No subsidized tasks available for this service.</div>`}
          <section class="total">
            <span>üëõ Total available subsidy:</span>
            <strong>${escapeHtml(formatDollars(totalSubsidyCents))}</strong>
          </section>
        `;

        root.querySelector('#back-btn')?.addEventListener('click', () => {
          void onBack();
        });

        for (const button of root.querySelectorAll('.start')) {
          button.addEventListener('click', () => {
            const campaignId = button.getAttribute('data-campaign-id');
            const taskName = button.getAttribute('data-task-name');
            const sponsor = button.getAttribute('data-sponsor');
            if (campaignId) {
              void onStartTask(campaignId, sponsor ?? '', taskName ?? 'Task');
            }
          });
        }

        notifyWidgetHeight(app);
      }

      render();
      notifyWidgetHeight(app);
    </script>
  </body>
</html>
