<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Form Widget</title>
    <style>
      :root {
        --bg: #f8fafc;
        --surface: #ffffff;
        --text: #0f172a;
        --muted: #475569;
        --border: #cbd5e1;
        --accent: #0ea5e9;
        --danger: #b91c1c;
      }

      body.dark {
        --bg: #0b1120;
        --surface: #111827;
        --text: #f1f5f9;
        --muted: #cbd5e1;
        --border: #334155;
        --accent: #38bdf8;
        --danger: #fca5a5;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--text);
        font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      }

      #app {
        max-width: 100%;
        padding: 12px;
      }

      .panel {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
      }

      h2 {
        margin: 0 0 8px 0;
        font-size: 16px;
      }

      .desc {
        margin: 0 0 12px 0;
        color: var(--muted);
        white-space: pre-wrap;
      }

      .field {
        display: grid;
        gap: 6px;
        margin-bottom: 10px;
      }

      .field label {
        font-size: 13px;
      }

      .field input,
      .field textarea {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 8px;
        background: transparent;
        color: var(--text);
        padding: 8px;
      }

      .checks {
        display: grid;
        gap: 8px;
        margin: 12px 0;
        color: var(--muted);
        font-size: 13px;
      }

      button[type='submit'] {
        border: 1px solid var(--accent);
        background: var(--accent);
        color: #fff;
        border-radius: 8px;
        padding: 10px 12px;
        cursor: pointer;
      }

      .done {
        border: 1px solid var(--accent);
        border-radius: 10px;
        padding: 10px;
      }

      .error {
        color: var(--danger);
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <main id="app"></main>
    <script type="module">
      import { initWidget, notifyWidgetHeight } from './common.ts';

      const { app, toolOutput } = initWidget();
      const root = document.getElementById('app');
      const data = toolOutput?.structuredContent ?? {};
      const task_input_format = data.task_input_format ?? {};
      const requiredFields = task_input_format?.required_fields ?? [];
      const already_completed = Boolean(data.already_completed);
      const task_description = data.task_description ?? '';
      const campaign_id = data.campaign_id ?? '';
      const required_task = data.required_task ?? '';

      async function callTool(name, input) {
        return app?.callTool?.(name, input);
      }

      function buildDynamicFields() {
        if (!Array.isArray(requiredFields) || requiredFields.length === 0) {
          return `<div class="field"><label for="details">Details</label><textarea id="details" rows="4"></textarea></div>`;
        }

        return requiredFields
          .map(
            (field) => `
            <div class="field">
              <label for="field-${field}">${field}</label>
              <input id="field-${field}" name="${field}" />
            </div>
          `
          )
          .join('');
      }

      async function onSubmit(event) {
        event.preventDefault();
        const form = event.currentTarget;
        const formData = new FormData(form);

        const detailsPayload = {};
        for (const key of formData.keys()) {
          if (key !== 'data_sharing_agreed' && key !== 'purpose_acknowledged' && key !== 'contact_permission') {
            detailsPayload[key] = formData.get(key);
          }
        }

        const consent = {
          data_sharing_agreed: formData.get('data_sharing_agreed') === 'on',
          purpose_acknowledged: formData.get('purpose_acknowledged') === 'on',
          contact_permission: formData.get('contact_permission') === 'on',
        };

        if (!consent.data_sharing_agreed || !consent.purpose_acknowledged || !consent.contact_permission) {
          const err = root.querySelector('.error');
          if (err) err.textContent = 'All three consent checkboxes are required.';
          return;
        }

        await callTool('complete_task', {
          campaign_id,
          task_name: required_task,
          details: JSON.stringify(detailsPayload),
          consent,
        });
      }

      function render() {
        if (!root) return;

        if (already_completed) {
          root.innerHTML = `
            <section class="panel done">
              <h2>Task Already Completed</h2>
              <p>This task has already been completed.</p>
            </section>
          `;
          notifyWidgetHeight(app);
          return;
        }

        root.innerHTML = `
          <section class="panel">
            <h2>Task Input Form</h2>
            <p class="desc">${task_description}</p>
            <form id="task-form">
              ${buildDynamicFields()}
              <div class="checks">
                <label><input type="checkbox" name="data_sharing_agreed" /> I agree to data sharing</label>
                <label><input type="checkbox" name="purpose_acknowledged" /> I understand the usage purpose</label>
                <label><input type="checkbox" name="contact_permission" /> I allow follow-up contact</label>
              </div>
              <p class="error"></p>
              <button type="submit">Submit</button>
            </form>
          </section>
        `;

        const form = root.querySelector('#task-form');
        form?.addEventListener('submit', onSubmit);
        notifyWidgetHeight(app);
      }

      render();
      notifyWidgetHeight(app);
    </script>
  </body>
</html>
