<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task Form Widget</title>
    <style>
      :root {
        --bg-0: #0f172a;
        --bg-1: #0c1222;
        --panel: #111827;
        --panel-soft: #1e293b;
        --border: #334155;
        --text: #f8fafc;
        --muted: #94a3b8;
        --accent: #0ea5e9;
        --ok: #22c55e;
        --danger: #fca5a5;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        color: var(--text);
        font-family: 'Space Grotesk', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: linear-gradient(160deg, var(--bg-0) 0%, var(--bg-1) 100%);
      }

      #app {
        width: 100%;
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid rgba(148, 163, 184, 0.18);
        box-shadow: 0 18px 44px rgba(2, 6, 23, 0.45);
      }

      .topbar {
        display: grid;
        grid-template-columns: auto 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 16px 20px;
      }

      .back {
        width: 30px;
        height: 30px;
        border-radius: 8px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--muted);
        cursor: pointer;
      }

      .task-name {
        margin: 0;
        font-size: 15px;
        font-weight: 700;
      }

      .task-meta {
        margin: 2px 0 0;
        color: var(--muted);
        font-size: 12px;
      }

      .status {
        border-radius: 999px;
        border: 1px solid #0ea5e9;
        background: rgba(14, 165, 233, 0.16);
        color: #bae6fd;
        font-size: 11px;
        padding: 3px 9px;
        white-space: nowrap;
      }

      .urlbar {
        padding: 0 20px 12px;
      }

      .url-inner {
        width: 100%;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--panel-soft);
        padding: 9px 12px;
        color: var(--muted);
        font-size: 12px;
      }

      .content {
        margin: 0 20px;
        border: 1px solid var(--border);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.58);
        padding: 14px;
      }

      .brand {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: #1e293b;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        margin-bottom: 10px;
      }

      .title {
        margin: 0 0 10px;
        font-size: 16px;
        font-weight: 700;
      }

      .field {
        display: grid;
        gap: 6px;
        margin-bottom: 10px;
      }

      .field label {
        font-size: 12px;
        color: #dbe5f3;
      }

      .field input,
      .field textarea {
        border: 1px solid var(--border);
        border-radius: 9px;
        background: var(--panel);
        color: var(--text);
        padding: 9px 10px;
        font-size: 13px;
      }

      .checks {
        display: grid;
        gap: 7px;
        margin: 10px 0 12px;
        color: var(--muted);
        font-size: 12px;
      }

      .create-btn {
        width: 100%;
        border: 1px solid var(--accent);
        border-radius: 10px;
        background: var(--accent);
        color: #fff;
        font-size: 13px;
        font-weight: 700;
        padding: 10px 12px;
        cursor: pointer;
      }

      .divider {
        height: 1px;
        margin: 14px 20px;
        background: var(--border);
      }

      .verify {
        margin: 0 20px;
        padding-bottom: 16px;
      }

      .verify-note {
        border-radius: 10px;
        border: 1px solid rgba(14, 165, 233, 0.45);
        background: rgba(14, 165, 233, 0.14);
        color: #bae6fd;
        padding: 10px 12px;
        font-size: 12px;
      }

      .verify-btn {
        width: 100%;
        margin-top: 10px;
        border: 1px solid var(--ok);
        border-radius: 10px;
        background: var(--ok);
        color: #052e16;
        font-size: 13px;
        font-weight: 700;
        padding: 10px 12px;
        cursor: pointer;
      }

      .alt {
        width: 100%;
        margin-top: 8px;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: transparent;
        color: var(--muted);
        padding: 9px 12px;
        font-size: 12px;
        cursor: pointer;
      }

      .footer {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 0 20px 16px;
        color: var(--muted);
        font-size: 12px;
      }

      .error {
        margin-top: 8px;
        color: var(--danger);
        font-size: 12px;
      }

      .done {
        padding: 18px 20px;
        color: #86efac;
        font-size: 14px;
      }

      @media (max-width: 520px) {
        #app {
          padding: 10px;
        }

        .panel {
          padding: 10px;
          border-radius: 10px;
        }

        h2 {
          font-size: 15px;
        }

        .task-options {
          display: grid;
          grid-template-columns: 1fr;
        }

        .task-option {
          width: 100%;
          text-align: left;
          font-size: 13px;
        }

        button[type='submit'],
        .alt-actions button {
          width: 100%;
          min-height: 44px;
        }

        .checks {
          font-size: 12px;
          gap: 10px;
        }
      }
    </style>
  </head>
  <body>
    <main id="app"></main>
    <script>
      function initWidget() {
        const app = window.openai;
        const isDark = app?.theme?.appearance === 'dark';
        document.body.classList.toggle('dark', isDark);

        if (typeof app?.maxHeight === 'number' && Number.isFinite(app.maxHeight)) {
          document.body.style.maxHeight = `${app.maxHeight}px`;
          document.body.style.overflowY = 'auto';
        }

        return {
          app,
          toolOutput: app?.toolOutput ?? null,
          widgetState: app?.widgetState ?? {},
          isDark,
        };
      }

      function notifyWidgetHeight(app) {
        app?.notifyIntrinsicHeight?.(document.body.scrollHeight);
      }

      const { app, toolOutput, widgetState } = initWidget();
      const root = document.getElementById('app');
      const data = toolOutput?.structuredContent ?? {};

      const campaignId = data.campaign_id ?? '';
      const sponsor = data.sponsor ?? 'Sponsor';
      const requiredTask = data.required_task ?? 'Task';
      const taskDescription = data.task_description ?? 'Complete the task to unlock sponsor coverage.';
      const subsidyAmount = Number(data.subsidy_amount_cents ?? 0) / 100;
      const task_input_format = data.task_input_format ?? {};
      const alreadyCompleted = Boolean(data.already_completed);
      const selectedServiceKey = typeof widgetState?.selectedServiceKey === 'string' ? widgetState.selectedServiceKey : '';
      const taskType = typeof task_input_format?.task_type === 'string' && task_input_format.task_type.length > 0 ? task_input_format.task_type : 'survey';
      const taskConstraints =
        task_input_format && typeof task_input_format === 'object' && task_input_format.constraints
          ? task_input_format.constraints
          : {};
      const isZkpassportTask = taskType === 'zkpassport_age_country';
      const selectedServiceName = typeof widgetState?.selectedServiceName === 'string' ? widgetState.selectedServiceName : selectedServiceKey || 'service';

      function escapeHtml(value) {
        return String(value ?? '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      async function callTool(name, input) {
        return app?.callTool?.(name, input);
      }

      function collectFields(form) {
        const payload = {};
        for (const [key, value] of new FormData(form).entries()) {
          if (key === 'data_sharing_agreed' || key === 'purpose_acknowledged' || key === 'contact_permission') continue;
          payload[key] = value;
        }
        return payload;
      }

      function allConsentsChecked(form) {
        const formData = new FormData(form);
        return (
          formData.get('data_sharing_agreed') === 'on' &&
          formData.get('purpose_acknowledged') === 'on' &&
          formData.get('contact_permission') === 'on'
        );
      }

      async function onBack() {
        if (!selectedServiceKey) return;
        await callTool('get_service_tasks', { service_key: selectedServiceKey });
      }

      async function onDirectPayment() {
        if (!selectedServiceKey) return;
        await callTool('run_service', {
          service: selectedServiceKey,
          input: '__pay_direct__',
        });
      }

      async function onSubmit(event) {
        event.preventDefault();
        const form = event.currentTarget;
        const err = root?.querySelector('.error');

        if (!allConsentsChecked(form)) {
          if (err) {
            err.textContent = 'All three consent checkboxes are required.';
            err.style.color = 'var(--danger)';
          }
          return;
        }

        const consent = {
          data_sharing_agreed: true,
          purpose_acknowledged: true,
          contact_permission: true,
        };

        if (isZkpassportTask) {
          if (err) {
            err.textContent = 'Creating verification session...';
            err.style.color = 'var(--muted)';
          }

          try {
            const response = await callTool('start_zkpassport_verification', {
              campaign_id: campaignId,
              consent,
            });
            const verificationUrl =
              response?.structuredContent?.verification_url ??
              response?._meta?.full_response?.verification_url ??
              null;

            if (typeof verificationUrl !== 'string' || verificationUrl.length === 0) {
              if (err) {
                err.textContent = 'Verification URL not returned. Please try again.';
                err.style.color = 'var(--danger)';
              }
              return;
            }

            window.open(verificationUrl, '_blank', 'noopener,noreferrer');
            if (err) {
              err.textContent = 'Verification opened in a new tab. Complete it and return to GPT.';
              err.style.color = 'var(--muted)';
            }
            return;
          } catch (error) {
            if (err) {
              err.textContent = error?.message || 'Failed to start verification.';
              err.style.color = 'var(--danger)';
            }
            return;
          }
        }

        const detailsPayload = collectFields(form);
        detailsPayload._task_description = taskDescription;

        await callTool('complete_task', {
          campaign_id: campaignId,
          task_name: requiredTask,
          details: JSON.stringify(detailsPayload),
          consent,
        });
      }

      function buildFields() {
        if (isZkpassportTask) {
          const minAge = Number(taskConstraints?.min_age ?? 18);
          const allowedCountries = Array.isArray(taskConstraints?.allowed_country_labels)
            ? taskConstraints.allowed_country_labels.join(', ')
            : 'EU countries, USA, Japan';

          return `
            <div class="verify-note" style="margin-bottom: 10px;">
              Human proof required: age must be <strong>${escapeHtml(String(minAge))}+</strong> and nationality must be in
              <strong>${escapeHtml(allowedCountries)}</strong>.
            </div>
          `;
        }

        const requiredFields = Array.isArray(task_input_format?.required_fields)
          ? task_input_format.required_fields
          : ['email', 'username', 'password'];
        const defaults = {
          email: 'you@example.com',
          username: 'Choose a username',
          password: 'Create a password',
        };

        return requiredFields
          .map((field) => {
            const lower = String(field).toLowerCase();
            const isLarge = lower.includes('detail') || lower.includes('proof') || lower.includes('response');
            const label = field.replaceAll('_', ' ');
            if (isLarge) {
              return `
                <div class="field">
                  <label for="${escapeHtml(field)}">${escapeHtml(label)}</label>
                  <textarea id="${escapeHtml(field)}" name="${escapeHtml(field)}" rows="3" placeholder="Provide ${escapeHtml(label)}"></textarea>
                </div>
              `;
            }
            return `
              <div class="field">
                <label for="${escapeHtml(field)}">${escapeHtml(label)}</label>
                <input id="${escapeHtml(field)}" name="${escapeHtml(field)}" placeholder="${escapeHtml(defaults[lower] ?? `Enter ${label}`)}" />
              </div>
            `;
          })
          .join('');
      }

      function render() {
        if (!root) return;

        if (alreadyCompleted) {
          root.innerHTML = `<div class="done">‚úÖ Task already completed. You can run the service now.</div>`;
          notifyWidgetHeight(app);
          return;
        }

        const brandInitials = String(selectedServiceName || 'SV')
          .split(/\s+/)
          .filter(Boolean)
          .slice(0, 2)
          .map((token) => token.charAt(0).toUpperCase())
          .join('');

        root.innerHTML = `
          <section class="topbar">
            <button class="back" id="back-btn">‚Üê</button>
            <div>
              <h2 class="task-name">${escapeHtml(requiredTask)}</h2>
              <p class="task-meta">by ${escapeHtml(sponsor)} ¬∑ Earn $${escapeHtml(subsidyAmount.toFixed(2))}</p>
            </div>
            <span class="status">In Progress</span>
          </section>
          <section class="urlbar">
            <div class="url-inner">üîí ${escapeHtml(selectedServiceName)} / ${isZkpassportTask ? 'verification' : 'signup'}</div>
          </section>
          <section class="content">
            <span class="brand">${escapeHtml(brandInitials || 'SV')}</span>
            <h3 class="title">${isZkpassportTask ? 'Complete age &amp; country verification' : `Create your ${escapeHtml(selectedServiceName)} account`}</h3>
            <form id="task-form">
              ${buildFields()}
              <div class="checks">
                <label><input type="checkbox" name="data_sharing_agreed" /> I agree to data sharing.</label>
                <label><input type="checkbox" name="purpose_acknowledged" /> I understand the usage purpose.</label>
                <label><input type="checkbox" name="contact_permission" /> I allow follow-up contact.</label>
              </div>
              ${isZkpassportTask ? '' : '<button type="button" class="create-btn">Create Account ‚Ä∫</button>'}
            </form>
          </section>
          <div class="divider"></div>
          <section class="verify">
            <div class="verify-note">‚ÑπÔ∏è ${escapeHtml(taskDescription)}</div>
            <button class="verify-btn" id="verify-btn">${isZkpassportTask ? 'Verify age & country' : 'Submit for Verification'}</button>
            <button class="alt" id="direct-payment">Use direct payment instead</button>
            <p class="error"></p>
          </section>
          <section class="footer">üõ°Ô∏è Your activity is verified on-chain</section>
        `;

        root.querySelector('#back-btn')?.addEventListener('click', () => {
          void onBack();
        });

        root.querySelector('#direct-payment')?.addEventListener('click', () => {
          void onDirectPayment();
        });

        root.querySelector('#verify-btn')?.addEventListener('click', () => {
          const form = root.querySelector('#task-form');
          if (form) {
            void onSubmit({ preventDefault() {}, currentTarget: form });
          }
        });

        root.querySelector('#task-form')?.addEventListener('submit', (event) => {
          void onSubmit(event);
        });

        notifyWidgetHeight(app);
      }

      render();
      notifyWidgetHeight(app);
    </script>
  </body>
</html>
